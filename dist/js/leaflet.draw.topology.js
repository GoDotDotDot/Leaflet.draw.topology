if(!L.Edit.Poly||!L.Handler.MarkerSnap)throw"Error: leaflet.draw.topology requires Leaflet.Draw and Leaflet.Snap";L.Edit.Poly.prototype.addHooks=function(){this._poly._map&&(this._markerGroup||this._initMarkers(),this._poly._map.addLayer(this._markerGroup),this._findTwins())},L.Edit.Poly.prototype._findTwins=function(){Object.keys(this._poly._map._layers).forEach(function(a){Object.keys(this._poly._map._layers).forEach(function(b){this._poly._map._layers[a]._origLatLng&&this._poly._map._layers[b]._origLatLng&&this._poly._map._layers[a]._origLatLng.lat===this._poly._map._layers[b]._origLatLng.lat&&this._poly._map._layers[a]._origLatLng.lng===this._poly._map._layers[b]._origLatLng.lng&&this._poly._map._layers[a]._leaflet_id!==this._poly._map._layers[b]._leaflet_id&&(this._poly._map._layers[a]._twinMarkers||(this._poly._map._layers[a]._twinMarkers=[]),this._poly._map._layers[a]._twinMarkers.indexOf(this._poly._map._layers[b])<0&&this._poly._map._layers[a]._twinMarkers.push(this._poly._map._layers[b]),this._poly._map._layers[b]._twinMarkers||(this._poly._map._layers[b]._twinMarkers=[]),this._poly._map._layers[b]._twinMarkers.indexOf(this._poly._map._layers[a])<0&&this._poly._map._layers[b]._twinMarkers.push(this._poly._map._layers[a]))}.bind(this))}.bind(this))},L.Edit.Poly.prototype._initMarkers=function(){this._markerGroup||(this._markerGroup=new L.LayerGroup),this._markers=[];var a,b,c,d,e=this._poly._latlngs;for(a=0,c=e.length;c>a;a++)d=this._createMarker(e[a],a),d.on("click",this._onMarkerClick,this),this._markers.push(d);var f,g;for(a=0,b=c-1;c>a;b=a++)(0!==a||L.Polygon&&this._poly instanceof L.Polygon)&&(f=this._markers[b],g=this._markers[a],this._updatePrevNext(f,g));this._updateIndexes()},L.Edit.Poly.prototype._createMarker=function(a,b){var c=new L.Marker(a,{draggable:!0,icon:this.options.icon});return c._origLatLng=a,c._index=b?b:a._index,c._layer=a._layer,a._hasTwin&&(c._hasTwin=!0,c._twinLayers=a._twinLayers),a._isMiddle&&(c._isMiddle=!0),c.on("drag",this._onMarkerDrag,this),c.on("dragend",this._fireEdit,this),this._markerGroup.addLayer(c),c},L.Edit.Poly.prototype._onMarkerDrag=function(a){var b=a.target,c=(b._origLatLng,[]);L.extend(b._origLatLng,b._latlng),b._middleLeft&&b._middleLeft.setLatLng(this._getMiddleLatLng(b._prev,b)),b._middleRight&&b._middleRight.setLatLng(this._getMiddleLatLng(b,b._next)),c.push(b._layer),b._hasTwin&&b._twinMarkers.forEach(function(a){a.setLatLng(b._latlng),a.update(),this._poly._map._layers[a._layer]._latlngs.forEach(function(a){a.lat===b._origLatLng.lat&&a.lng===b._origLatLng.lng&&(a.lat=b._latlng.lat,a.lng=b._latlng.lng)}),L.extend(a._origLatLng,b._latlng),c.push(a._layer)}.bind(this)),c.forEach(function(a){this._poly._map._layers[a].editing._poly.redraw()}.bind(this))},L.Handler.MarkerSnap.prototype._updateSnap=function(a,b,c){b&&c?(a._latlng=L.latLng(c),a.update(),a.snap!=b&&(a.snap=b,a._icon&&L.DomUtil.addClass(a._icon,"marker-snapped"),this._map.fire("snap",{marker_id:a._leaflet_id,layer_id:b._leaflet_id,marker:a}),a.fire("snap",{layer:b,latlng:c}))):(a.snap&&(a._icon&&L.DomUtil.removeClass(a._icon,"marker-snapped"),this._map.fire("unsnap",{marker_id:a._leaflet_id,marker:a}),a.fire("unsnap",{layer:a.snap})),delete a.snap)},L.Edit.Topology={init:function(a,b,c){this._map=a;var d=c&&c.icon?c.icon:new L.DivIcon({iconSize:new L.Point(10,10),className:"leaflet-div-icon leaflet-editing-icon"});d.options.className=d.options.className+" propagateDrag",this.marker=new L.Marker(this._map.getCenter(),{icon:d,repeatMode:!1,zIndexOffset:2e3}).addTo(this._map),this._map.on("mousemove",function(a){this.marker.setLatLng(a.latlng)}.bind(this)),this.marker.snapediting=new L.Handler.MarkerSnap(this._map,this.marker),this.marker.snapediting.addGuideLayer(drawnItems),this.marker.snapediting.enable(),this._map.removeLayer(this.marker),this.marker.snapediting.disable(),this._map.on("snap",function(a){L.DomUtil.removeClass(a.marker._icon,"hidden"),this._map._snapLayer=a.layer_id}.bind(this)),this._map.on("unsnap",function(a){L.DomUtil.addClass(a.marker._icon,"hidden"),this._map._snapLayer=""}.bind(this)),Object.keys(b._layers).forEach(function(a){b._layers[a].on("click",function(a){if(a.target.editing._enabled)if(this._map._snapLayer){{new L.Marker(this.marker.getLatLng(),{icon:L.Edit.Poly.prototype.options.icon,draggable:!0})}this._map.fire("marker-created",this.marker)}else this._map.removeLayer(this.marker),this.marker.snapediting.disable(),this._findAdjacencies("disable",a.target);else this._map.addLayer(this.marker),this.marker.snapediting.enable(),this._findAdjacencies("enable",a.target)}.bind(this))}.bind(this)),b.addTo(this._map),this._map.on("marker-created",function(b){if(this._map._snapLayer){var c=this._map._snapLayer,d=this.sortPolygon(this._map._snapLayer,b),e={lat:b._latlng.lat,lng:b._latlng.lng,layer:c};if(e.layer=c,d[0]._index===this._map._layers[c].editing._poly._latlngs.length-1)var f=this._isBetween(this._map._layers[c].editing._poly._latlngs[d[0]._index],this._map._layers[c].editing._poly._latlngs[0],b._latlng)?1:0;else var f=this._isBetween(this._map._layers[c].editing._poly._latlngs[d[0]._index],this._map._layers[c].editing._poly._latlngs[d[0]._index+1],b._latlng)?1:0;var g=d[0]._index+f,h=[];if(d[0]._hasTwin){var i=1===f?1:-1;i=0===d[0]._index&&-1===i?this._map._layers[c].editing._poly._latlngs.length-1:d[0]._index===this._map._layers[c].editing._poly._latlngs.length-1&&1===f?0:d[0]._index===this._map._layers[c].editing._poly._latlngs.length-1?d[0]._index-1:d[0]._index+i;var j=a._layers[c].editing._poly._latlngs[i]._hasTwin;j&&function(){var a;if(d[0]._twinLayers.length>1&&this._map._layers[c].editing._poly._latlngs[i]._twinLayers.length>1){var f=d[0]._twinLayers.filter(function(a){return-1!=this._map._layers[c].editing._poly._latlngs[i]._twinLayers.indexOf(a)}.bind(this));if(f.length>1&&(f=f.filter(function(a){return-1===d[0]._twinLayers.indexOf(a)})),0===f.length)return;a=f[0]}else if(d[0]._twinLayers.length>1&&1===this._map._layers[c].editing._poly._latlngs[i]._twinLayers.length)a=this._map._layers[c].editing._poly._latlngs[i]._twinLayers[0];else{if(1===d[0]._twinLayers.length&&1===this._map._layers[c].editing._poly._latlngs[i]._twinLayers.length)return;1===d[0]._twinLayers.length?a=d[0]._twinLayers[0]:console.log("Something went wrong....")}var g=this.sortPolygon(a,b),j={lat:b._latlng.lat,lng:b._latlng.lng,layer:a,_hasTwin:!0,_twin:{layer:c},_twinLayers:g[0]._twinLayers};if(g[0]._index===this._map._layers[a].editing._poly._latlngs.length-1)var k=this._isBetween(this._map._layers[a].editing._poly._latlngs[g[0]._index],this._map._layers[a].editing._poly._latlngs[g[0]._index-1],b._latlng)?0:1;else var k=this._isBetween(this._map._layers[a].editing._poly._latlngs[g[0]._index],this._map._layers[a].editing._poly._latlngs[g[0]._index+1],b._latlng)?1:0;var l=g[0]._index+k;e._hasTwin=!0,e._twinLayers=d[0]._twinLayers,this._map._layers[a].editing._poly._latlngs.splice(l,0,j),h.push(a)}.bind(this)()}this._map._layers[c].editing._poly._latlngs.splice(g,0,e),h.push(c),this.reset(),this.redrawPolys(h)}}.bind(this)),setTimeout(function(){Object.keys(this._map._layers).forEach(function(a){this._map._layers[a]._latlngs&&(this._map._layers[a].adjacencies=[])}.bind(this)),this.missingVertices()}.bind(this),500)},_findAdjacencies:function(a,b){var c=[];b.adjacencies.forEach(function(a){c.indexOf(a.toString())<0&&c.push(a.toString()),this._map._layers[a].adjacencies.forEach(function(a){c.indexOf(a.toString())<0&&c.push(a.toString())})}.bind(this)),c.indexOf(b._leaflet_id.toString())<0&&c.push(b._leaflet_id.toString()),"enable"===a?this.enableEditing(c):this.disableEditing(c)},enableEditing:function(a){a.forEach(function(a){this._map._layers[a].editing.addHooks(),this._map._layers[a].editing._enabled=!0,this._map._layers[a].setStyle({fillColor:"#fff",color:"#666",opacity:.5})}.bind(this))},disableEditing:function(a){a.forEach(function(a){this._map._layers[a].editing.removeHooks(),this._map._layers[a].editing._enabled=!1,this._map._layers[a].setStyle({fillColor:"#777",color:"#444",opacity:.8})}.bind(this))},_distance:function(a,b){function c(a){return a*Math.PI/180}var d=c(b.lat-a.lat),e=c(b.lng-a.lng),f=Math.sin(d/2)*Math.sin(d/2)+Math.sin(e/2)*Math.sin(e/2)*Math.cos(c(a.lat))*Math.cos(c(b.lat)),g=2*Math.atan2(Math.sqrt(f),Math.sqrt(1-f));return g},_isBetween:function(a,b,c){var d=this._distance(a,b),e=(c.lat-a.lat)*(b.lng-a.lng)-(c.lng-a.lng)*(b.lat-a.lat);if(Math.abs(e)>d)return!1;var f=(c.lng-a.lng)*(b.lng-a.lng)+(c.lat-a.lat)*(b.lat-a.lat);if(0>f)return!1;var g=(b.lng-a.lng)*(b.lng-a.lng)+(b.lat-a.lat)*(b.lat-a.lat);return f>g?!1:!0},sortPolygon:function(a,b){var c=[];return this._map._layers[a].editing._poly._latlngs.forEach(function(a){var d={_index:a._index,_hasTwin:a._hasTwin,dist:this._distance(a,b._latlng)};a._hasTwin&&(d._twinLayers=a._twinLayers),c.push(d)}.bind(this)),c=c.sort(function(a,b){return a.dist-b.dist})},redrawPolys:function(a){a.forEach(function(a){this._map._layers[a].editing.enabled&&(this._map._layers[a].editing.removeHooks(),this._map._layers[a].editing.addHooks())}.bind(this))},reset:function(){Object.keys(this._map._layers).forEach(function(a){Object.keys(this._map._layers).forEach(function(b){this._map._layers[a]._latlngs&&this._map._layers[b]._latlngs&&this._map._layers[a]._latlngs.forEach(function(c,d){c._layer=a,c._index=d,this._map._layers[b]._latlngs.forEach(function(d){c.lat===d.lat&&c.lng===d.lng&&a!==b&&(c._hasTwin=!0,c._twinLayers||(c._twinLayers=[]),c._twinLayers.indexOf(b)<0&&c._twinLayers.push(b),d._hasTwin=!0,d._twinLayers||(d._twinLayers=[]),d._twinLayers.indexOf(a)<0&&d._twinLayers.push(a),this._map._layers[a].adjacencies.indexOf(b)<0&&this._map._layers[a].adjacencies.push(b),this._map._layers[b].adjacencies.indexOf(a)<0&&this._map._layers[b].adjacencies.push(a))}.bind(this))}.bind(this))}.bind(this))}.bind(this))},addMissingVertex:function(a,b,c,d,e){if(this._isBetween(c,this._map._layers[a]._latlngs[d+1],e)){var f=[c.lat,c.lng],g=[this._map._layers[a]._latlngs[d+1].lat,this._map._layers[a]._latlngs[d+1].lng],h=[e.lat,e.lng],i=f.filter(function(a){return-1!=h.indexOf(a)}),j=g.filter(function(a){return-1!=h.indexOf(a)});if(1===i.length&&1===j.length){var k={lat:e.lat,lng:e.lng,layer:a,_twinLayers:[a,b],_hasTwin:!0};this._map._layers[a]._latlngs.splice(d+1,0,k)}}},missingVertices:function(){Object.keys(this._map._layers).forEach(function(a){Object.keys(this._map._layers).forEach(function(b){this._map._layers[a]._latlngs&&this._map._layers[b]._latlngs&&a!=b&&this._map._layers[a]._latlngs.forEach(function(c,d){this._map._layers[b]._latlngs.forEach(function(e){d+1<=this._map._layers[a]._latlngs.length-1&&d<this._map._layers[a]._latlngs.length-1?this.addMissingVertex(a,b,c,d,e):d===this._map._layers[a]._latlngs.length-1&&this.addMissingVertex(a,b,c,-1,e)}.bind(this))}.bind(this))}.bind(this))}.bind(this)),this.reset()}};