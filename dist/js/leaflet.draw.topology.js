if(!L.Edit.Poly||!L.Handler.MarkerSnap)throw"Error: leaflet.draw.topology requires Leaflet.Draw and Leaflet.Snap";L.Edit.Poly.prototype.addHooks=function(){this._poly._map&&(this._markerGroup||this._initMarkers(),this._poly._map.addLayer(this._markerGroup),this._findTwins())},L.Edit.Poly.prototype._findTwins=function(){Object.keys(this._poly._map._layers).forEach(function(a){Object.keys(this._poly._map._layers).forEach(function(b){this._poly._map._layers[a]._origLatLng&&this._poly._map._layers[b]._origLatLng&&this._poly._map._layers[a]._origLatLng.lat===this._poly._map._layers[b]._origLatLng.lat&&this._poly._map._layers[a]._origLatLng.lng===this._poly._map._layers[b]._origLatLng.lng&&this._poly._map._layers[a]._leaflet_id!==this._poly._map._layers[b]._leaflet_id&&(this._poly._map._layers[a]._twinMarkers||(this._poly._map._layers[a]._twinMarkers=[]),this._poly._map._layers[a]._twinMarkers.indexOf(this._poly._map._layers[b])<0&&this._poly._map._layers[a]._twinMarkers.push(this._poly._map._layers[b]),this._poly._map._layers[b]._twinMarkers||(this._poly._map._layers[b]._twinMarkers=[]),this._poly._map._layers[b]._twinMarkers.indexOf(this._poly._map._layers[a])<0&&this._poly._map._layers[b]._twinMarkers.push(this._poly._map._layers[a]))}.bind(this))}.bind(this))},L.Edit.Poly.prototype._initMarkers=function(){this._markerGroup||(this._markerGroup=new L.LayerGroup),this._markers=[];var a,b,c,d,e=this._poly._latlngs;for(a=0,c=e.length;c>a;a++)d=this._createMarker(e[a],a),d.on("click",this._onMarkerClick,this),this._markers.push(d);var f,g;for(a=0,b=c-1;c>a;b=a++)(0!==a||L.Polygon&&this._poly instanceof L.Polygon)&&(f=this._markers[b],g=this._markers[a],this._updatePrevNext(f,g));this._updateIndexes()},L.Edit.Poly.prototype._createMarker=function(a,b){var c=new L.Marker(a,{draggable:!0,icon:this.options.icon});return c._origLatLng=a,c._index=b?b:a._index,c._layer=a._layer,a._hasTwin&&(c._hasTwin=!0,c._twinLayers=a._twinLayers),a._isMiddle&&(c._isMiddle=!0),c.on("drag",this._onMarkerDrag,this),c.on("dragend",this._fireEdit,this),this._markerGroup.addLayer(c),c},L.Edit.Poly.prototype._onMarkerClick=function(){},L.Edit.Poly.prototype._onMarkerDrag=function(a){var b=a.target,c=(b._origLatLng,[]);L.extend(b._origLatLng,b._latlng),b._middleLeft&&b._middleLeft.setLatLng(this._getMiddleLatLng(b._prev,b)),b._middleRight&&b._middleRight.setLatLng(this._getMiddleLatLng(b,b._next)),c.push(b._layer),b._hasTwin&&b._twinMarkers.forEach(function(a){a.setLatLng(b._latlng),a.update(),this._poly._map._layers[a._layer]._latlngs.forEach(function(a){a.lat===b._origLatLng.lat&&a.lng===b._origLatLng.lng&&(a.lat=b._latlng.lat,a.lng=b._latlng.lng)}),L.extend(a._origLatLng,b._latlng),c.push(a._layer)}.bind(this)),c.forEach(function(a){this._poly._map._layers[a].editing._poly.redraw()}.bind(this))},L.Handler.MarkerSnap.prototype._updateSnap=function(a,b,c){b&&c?(a._latlng=L.latLng(c),a.update(),a.snap!=b&&(a.snap=b,a._icon&&L.DomUtil.addClass(a._icon,"marker-snapped"),this._map.fire("snap",{marker_id:a._leaflet_id,layer_id:b._leaflet_id,marker:a}),a.fire("snap",{layer:b,latlng:c}))):(a.snap&&(a._icon&&L.DomUtil.removeClass(a._icon,"marker-snapped"),this._map.fire("unsnap",{marker_id:a._leaflet_id,marker:a}),a.fire("unsnap",{layer:a.snap})),delete a.snap)},L.Edit.Topology={init:function(a,b,c){this._map=a;var d=c&&c.icon?c.icon:new L.DivIcon({iconSize:new L.Point(10,10),className:"leaflet-div-icon leaflet-editing-icon"});d.options.className=d.options.className+" propagateDrag",this.marker=new L.Marker(this._map.getCenter(),{icon:d,repeatMode:!1,zIndexOffset:2e3}).addTo(this._map),this._map.on("mousemove",function(a){this.marker.setLatLng(a.latlng)}.bind(this)),this.marker.snapediting=new L.Handler.MarkerSnap(this._map,this.marker),this.marker.snapediting.addGuideLayer(drawnItems),this.marker.snapediting.enable(),this._map.removeLayer(this.marker),this.marker.snapediting.disable(),this._map.on("snap",function(a){L.DomUtil.removeClass(a.marker._icon,"hidden"),this._map._snapLayer=a.layer_id}.bind(this)),this._map.on("unsnap",function(a){L.DomUtil.addClass(a.marker._icon,"hidden"),this._map._snapLayer=""}.bind(this)),Object.keys(b._layers).forEach(function(a){b._layers[a].on("click",function(a){if(a.target.editing._enabled)if(this._map._snapLayer){{new L.Marker(this.marker.getLatLng(),{icon:L.Edit.Poly.prototype.options.icon,draggable:!0})}this._map.fire("marker-created",this.marker)}else this._map.removeLayer(this.marker),this.marker.snapediting.disable(),this._findAdjacencies("disable",a.target);else this._map.addLayer(this.marker),this.marker.snapediting.enable(),this._findAdjacencies("enable",a.target)}.bind(this))}.bind(this)),b.addTo(this._map),this._map.on("marker-created",function(a){if(this._map._snapLayer){for(var b=this._map._snapLayer,c=[],d={lat:a._latlng.lat,lng:a._latlng.lng},e=this._map._layers[b].editing._poly._latlngs,f=0;f<e.length;f++)if(f+1<=e.length-1){if(this._isBetween(e[f],e[f+1],a._latlng)){var g=f,h=f+1;break}}else if(this._isBetween(e[f],e[0],a._latlng)){var g=f,h=0;break}e[g]._hasTwin&&e[h]._hasTwin&&function(){if(e[g]._twinLayers.length>1&&e[h]._twinLayers.length>1){var f=e[g]._twinLayers.filter(function(a){return-1!=e[h]._twinLayers.indexOf(a)}.bind(this));if(f.length>1)var i=f.filter(function(a){return-1===e[g]._twinLayers.indexOf(a)});else var i=f;if(0===i.length){var j=e[g]._twinLayers.filter(function(a){return e[h]._twinLayers.indexOf(a)>-1}.bind(this));if(j.length!==f.length)return;j.splice(j.indexOf(b.toString()),1);var k=j[0]}else var k=i[0]}else if(e[g]._twinLayers.length>1&&1===e[h]._twinLayers.length)var k=e[h]._twinLayers[0];else if(1===e[g]._twinLayers.length&&e[h]._twinLayers.length>1)var k=e[g]._twinLayers[0];else if(1===e[g]._twinLayers.length&&1===e[h]._twinLayers.length)return;for(var l=this._map._layers[k].editing._poly._latlngs,m=0;m<l.length;m++)if(m+1<=l.length-1){if(this._isBetween(l[m],l[m+1],a._latlng)){var n=m+1;break}}else if(this._isBetween(l[m],l[0],a._latlng)){var n=0;break}var o={lat:a._latlng.lat,lng:a._latlng.lng,_hasTwin:!0,_twin:{layer:b},_twinLayers:[b.toString(),k]};d._hasTwin=!0,d._twinLayers=[b.toString(),k],l.splice(n,0,o),c.push(k)}.bind(this)(),e.splice(h,0,d),c.push(b),this.reset(),this.redrawPolys(c)}}.bind(this)),setTimeout(function(){Object.keys(this._map._layers).forEach(function(a){this._map._layers[a]._latlngs&&(this._map._layers[a].adjacencies=[])}.bind(this)),this.missingVertices()}.bind(this),500)},_findAdjacencies:function(a,b){var c=[];b.adjacencies.forEach(function(a){c.indexOf(a.toString())<0&&c.push(a.toString()),this._map._layers[a].adjacencies.forEach(function(a){c.indexOf(a.toString())<0&&c.push(a.toString())})}.bind(this)),c.indexOf(b._leaflet_id.toString())<0&&c.push(b._leaflet_id.toString()),"enable"===a?this.enableEditing(c):this.disableEditing(c)},enableEditing:function(a){a.forEach(function(a){this._map._layers[a].editing.addHooks(),this._map._layers[a].editing._enabled=!0,this._map._layers[a].setStyle({fillColor:"#fff",color:"#666",opacity:.5})}.bind(this))},disableEditing:function(a){a.forEach(function(a){this._map._layers[a].editing.removeHooks(),this._map._layers[a].editing._enabled=!1,this._map._layers[a].setStyle({fillColor:"#777",color:"#444",opacity:.8})}.bind(this))},_distance:function(a,b){function c(a){return a*Math.PI/180}var d=c(b.lat-a.lat),e=c(b.lng-a.lng),f=Math.sin(d/2)*Math.sin(d/2)+Math.sin(e/2)*Math.sin(e/2)*Math.cos(c(a.lat))*Math.cos(c(b.lat)),g=2*Math.atan2(Math.sqrt(f),Math.sqrt(1-f));return g},_isBetween:function(a,b,c){var d=this._distance(a,b),e=(c.lat-a.lat)*(b.lng-a.lng)-(c.lng-a.lng)*(b.lat-a.lat);if(Math.abs(e)>d)return!1;var f=(c.lng-a.lng)*(b.lng-a.lng)+(c.lat-a.lat)*(b.lat-a.lat);if(0>f)return!1;var g=(b.lng-a.lng)*(b.lng-a.lng)+(b.lat-a.lat)*(b.lat-a.lat);return f>g?!1:!0},redrawPolys:function(a){a.forEach(function(a){this._map._layers[a].editing.enabled&&(this._map._layers[a].editing.removeHooks(),this._map._layers[a].editing.addHooks())}.bind(this))},reset:function(){Object.keys(this._map._layers).forEach(function(a){Object.keys(this._map._layers).forEach(function(b){this._map._layers[a]._latlngs&&this._map._layers[b]._latlngs&&this._map._layers[a]._latlngs.forEach(function(c,d){c._layer=a,c._index=d,this._map._layers[b]._latlngs.forEach(function(d){c.lat===d.lat&&c.lng===d.lng&&a!==b&&(c._hasTwin=!0,c._twinLayers||(c._twinLayers=[]),c._twinLayers.indexOf(b)<0&&c._twinLayers.push(b),d._hasTwin=!0,d._twinLayers||(d._twinLayers=[]),d._twinLayers.indexOf(a)<0&&d._twinLayers.push(a),this._map._layers[a].adjacencies.indexOf(b)<0&&this._map._layers[a].adjacencies.push(b),this._map._layers[b].adjacencies.indexOf(a)<0&&this._map._layers[b].adjacencies.push(a))}.bind(this))}.bind(this))}.bind(this))}.bind(this))},addMissingVertex:function(a,b,c,d,e){if(this._isBetween(c,this._map._layers[a]._latlngs[d+1],e)){var f=[c.lat,c.lng],g=[this._map._layers[a]._latlngs[d+1].lat,this._map._layers[a]._latlngs[d+1].lng],h=[e.lat,e.lng],i=f.filter(function(a){return-1!=h.indexOf(a)}),j=g.filter(function(a){return-1!=h.indexOf(a)});if(1===i.length&&1===j.length){var k={lat:e.lat,lng:e.lng,layer:a,_twinLayers:[a,b],_hasTwin:!0};this._map._layers[a]._latlngs.splice(d+1,0,k)}}},missingVertices:function(){Object.keys(this._map._layers).forEach(function(a){Object.keys(this._map._layers).forEach(function(b){this._map._layers[a]._latlngs&&this._map._layers[b]._latlngs&&a!=b&&this._map._layers[a]._latlngs.forEach(function(c,d){this._map._layers[b]._latlngs.forEach(function(e){d+1<=this._map._layers[a]._latlngs.length-1&&d<this._map._layers[a]._latlngs.length-1?this.addMissingVertex(a,b,c,d,e):d===this._map._layers[a]._latlngs.length-1&&this.addMissingVertex(a,b,c,-1,e)}.bind(this))}.bind(this))}.bind(this))}.bind(this)),this.reset()}};