if(!L.Edit.Poly||!L.Handler.MarkerSnap)throw"Error: leaflet.draw.topology requires Leaflet.Draw and Leaflet.Snap";L.Edit.Poly.prototype.addHooks=function(){this._poly._map&&(this._markerGroup||this._initMarkers(),this._poly._map.addLayer(this._markerGroup),this._findTwins())},L.Edit.Poly.prototype._findTwins=function(){Object.keys(this._poly._map._layers).forEach(function(a){Object.keys(this._poly._map._layers).forEach(function(b){this._poly._map._layers[a]._origLatLng&&this._poly._map._layers[b]._origLatLng&&this._poly._map._layers[a]._origLatLng.lat===this._poly._map._layers[b]._origLatLng.lat&&this._poly._map._layers[a]._origLatLng.lng===this._poly._map._layers[b]._origLatLng.lng&&this._poly._map._layers[a]._leaflet_id!==this._poly._map._layers[b]._leaflet_id&&(this._poly._map._layers[a]._twinMarkers||(this._poly._map._layers[a]._twinMarkers=[]),this._poly._map._layers[a]._twinMarkers.indexOf(this._poly._map._layers[b])<0&&this._poly._map._layers[a]._twinMarkers.push(this._poly._map._layers[b]),this._poly._map._layers[b]._twinMarkers||(this._poly._map._layers[b]._twinMarkers=[]),this._poly._map._layers[b]._twinMarkers.indexOf(this._poly._map._layers[a])<0&&this._poly._map._layers[b]._twinMarkers.push(this._poly._map._layers[a]))}.bind(this))}.bind(this))},L.Edit.Poly.prototype._initMarkers=function(){this._markerGroup||(this._markerGroup=new L.LayerGroup),this._markers=[];for(var a,b,c,d,e=this._poly._latlngs,a=0,c=e.length;c>a;a++)if(this._primary)d=this._createMarker(e[a],a),d.on("click",this._onMarkerClick,this),this._markers.push(d);else if(e[a]._twinLayers)for(var b=0;b<e[a]._twinLayers.length;b++)this._poly._map._layers[e[a]._twinLayers[b]].editing._primary&&(d=this._createMarker(e[a],a),d.on("click",this._onMarkerClick,this),this._markers.push(d));for(var f,g,a=0,b=c-1;c>a;b=a++)(0!==a||L.Polygon&&this._poly instanceof L.Polygon)&&(f=this._markers[b],g=this._markers[a],this._updatePrevNext(f,g));this._updateIndexes()},L.Edit.Poly.prototype._createMarker=function(a,b){var c=new L.Marker(a,{draggable:!0,icon:this.options.icon});return c._origLatLng=a,c._index=b?b:a._index,c._layer=a._layer,a._hasTwin&&(c._hasTwin=!0,c._twinLayers=a._twinLayers),a._isMiddle&&(c._isMiddle=!0),c.on("drag",this._onMarkerDrag,this),c.on("dragend",this._fireEdit,this),this._markerGroup.addLayer(c),c},L.Edit.Poly.prototype._onMarkerClick=function(){},L.Edit.Poly.prototype._onMarkerDrag=function(a){var b=a.target,c=(b._origLatLng,[]);L.extend(b._origLatLng,b._latlng),b._middleLeft&&b._middleLeft.setLatLng(this._getMiddleLatLng(b._prev,b)),b._middleRight&&b._middleRight.setLatLng(this._getMiddleLatLng(b,b._next)),c.push(b._layer),b._hasTwin&&b._twinMarkers.forEach(function(a){a.setLatLng(b._latlng),a.update(),this._poly._map._layers[a._layer]._latlngs.forEach(function(a){a.lat===b._origLatLng.lat&&a.lng===b._origLatLng.lng&&(a.lat=b._latlng.lat,a.lng=b._latlng.lng)}),L.extend(a._origLatLng,b._latlng),c.push(a._layer)}.bind(this)),c.forEach(function(a){this._poly._map._layers[a].editing._poly.redraw()}.bind(this))},L.Handler.MarkerSnap.prototype._updateSnap=function(a,b,c){b&&c?(a._latlng=L.latLng(c),a.update(),a.snap!=b&&(a.snap=b,a._icon&&L.DomUtil.addClass(a._icon,"marker-snapped"),this._map.fire("snap",{marker_id:a._leaflet_id,layer_id:b._leaflet_id,marker:a}),a.fire("snap",{layer:b,latlng:c}))):(a.snap&&(a._icon&&L.DomUtil.removeClass(a._icon,"marker-snapped"),this._map.fire("unsnap",{marker_id:a._leaflet_id,marker:a}),a.fire("unsnap",{layer:a.snap})),delete a.snap)},L.Edit.Topology={init:function(a,b,c,d){this._map=a,this._map._editStatus={layer:null,editing:!1},this._layers=b;var e=c&&c.icon?c.icon:new L.DivIcon({iconSize:new L.Point(10,10),className:"leaflet-div-icon leaflet-editing-icon"});e.options.className=e.options.className+" propagateDrag",this.marker=new L.Marker(this._map.getCenter(),{icon:e,repeatMode:!1,zIndexOffset:2e3}).addTo(this._map),this._map.on("mousemove",function(a){this.marker.setLatLng(a.latlng)}.bind(this)),this.marker.snapediting=new L.Handler.MarkerSnap(this._map,this.marker),this.marker.snapediting.addGuideLayer(b),this.marker.snapediting.enable(),this._map.removeLayer(this.marker),this.marker.snapediting.disable(),this._map.on("snap",function(a){L.DomUtil.removeClass(a.marker._icon,"hidden"),this._map._snapLayer=a.layer_id}.bind(this)),this._map.on("unsnap",function(a){L.DomUtil.addClass(a.marker._icon,"hidden"),this._map._snapLayer=""}.bind(this)),Object.keys(b._layers).forEach(function(a){b._layers[a].on("click",function(a){if(a.target.editing._enabled)if(this._map._snapLayer){{new L.Marker(this.marker.getLatLng(),{icon:L.Edit.Poly.prototype.options.icon,draggable:!0})}this._map.fire("marker-created",this.marker)}else a.target.editing._primary?(this._map.removeLayer(this.marker),this.marker.snapediting.disable(),this._findAdjacencies("disable",a.target)):(this.disableEditing(this._map._editStatus.layer._leaflet_id,this._map._editStatus.layer.adjacencies),this._findAdjacencies("enable",a.target));else this._map._editStatus.editing?(this.disableEditing(this._map._editStatus.layer._leaflet_id,this._map._editStatus.layer.adjacencies),this._findAdjacencies("enable",a.target)):(this._map.addLayer(this.marker),this.marker.snapediting.enable(),this._findAdjacencies("enable",a.target))}.bind(this))}.bind(this)),b.addTo(this._map),this._map.on("marker-created",function(b){if(this._map._snapLayer){for(var c=this._map._snapLayer,d=[],e={lat:b._latlng.lat,lng:b._latlng.lng},f=this._map._layers[c].editing._poly._latlngs,g=0;g<f.length;g++)if(g+1<=f.length-1){if(this._isBetween(f[g],f[g+1],b._latlng)){var h=g,i=g+1;break}}else if(this._isBetween(f[g],f[0],b._latlng)){var h=g,i=0;break}if(f[h]._hasTwin&&f[i]._hasTwin)var j=function(){if(f[h]._twinLayers.length>1&&f[i]._twinLayers.length>1){var a=f[h]._twinLayers.filter(function(a){return-1!=f[i]._twinLayers.indexOf(a)}.bind(this));if(a.length>1)var d=a.filter(function(a){return-1===f[h]._twinLayers.indexOf(a)});else var d=a;if(0===d.length){var e=f[h]._twinLayers.filter(function(a){return f[i]._twinLayers.indexOf(a)>-1}.bind(this));if(e.length!==a.length)return;e.splice(e.indexOf(c.toString()),1);var g=e[0]}else var g=d[0]}else if(f[h]._twinLayers.length>1&&1===f[i]._twinLayers.length)var g=f[i]._twinLayers[0];else if(1===f[h]._twinLayers.length&&f[i]._twinLayers.length>1)var g=f[h]._twinLayers[0];else if(1===f[h]._twinLayers.length&&1===f[i]._twinLayers.length)return;for(var j=this._map._layers[g].editing._poly._latlngs,k=0;k<j.length;k++)if(k+1<=j.length-1){if(this._isBetween(j[k],j[k+1],b._latlng)){var l=k+1;break}}else if(this._isBetween(j[k],j[0],b._latlng)){var l=0;break}var m={lat:b._latlng.lat,lng:b._latlng.lng,_hasTwin:!0,_twin:{layer:c},_twinLayers:[c.toString(),g]};return{otherPoly:g,otherPolyCoordinates:j,otherMarkerToInsert:m,otherVertex2:l}}.bind(this)();if(j){if(!this._map._layers[j.otherPoly].editing._primary&&!this._map._layers[c].editing._primary)return;e._hasTwin=!0,e._twinLayers=[c.toString(),j.otherPoly],j.otherPolyCoordinates.splice(j.otherVertex2,0,j.otherMarkerToInsert),d.push(j.otherPoly),f.splice(i,0,e),d.push(c),this.match(d),this.redrawPolys(d)}else{if(!a._layers[c].editing._primary)return;f.splice(i,0,e),d.push(c),this.match(d),this.redrawPolys(d)}}}.bind(this)),setTimeout(function(){Object.keys(this._map._layers).forEach(function(a){this._map._layers[a]._latlngs&&(this._map._layers[a].adjacencies=[])}.bind(this)),this.missingVertices(d)}.bind(this),200)},_findAdjacencies:function(a,b){var c=[];b.adjacencies.forEach(function(a){a!==b._leaflet_id&&c.indexOf(a.toString())<0&&c.push(a.toString())}.bind(this)),"enable"===a?this.enableEditing(b._leaflet_id,c):this.disableEditing(b._leaflet_id,c)},enableEditing:function(a,b){this._map._editStatus={layer:this._map._layers[a],editing:!0},this._map._layers[a].editing._enabled=!0,this._map._layers[a].editing._primary=!0,this._map._layers[a].editing.addHooks(),this._map._layers[a].setStyle({fillColor:"#eee",color:"#666",opacity:.5}),b.forEach(function(a){this._map._layers[a].editing._enabled=!0,this._map._layers[a].editing._neighbor=!0,this._map._layers[a].editing.addHooks(),this._map._layers[a].setStyle({fillColor:"#777",color:"#666",opacity:.8})}.bind(this))},disableEditing:function(a,b){this._map._editStatus={layer:null,editing:!1},this._map._layers[a].editing._enabled=!1,this._map._layers[a].editing._primary=!1,this._map._layers[a].editing.removeHooks(),this._map._layers[a].setStyle({fillColor:"#000",color:"#444",opacity:.8}),b.forEach(function(a){this._map._layers[a].editing._enabled=!1,this._map._layers[a].editing._neighbor=!1,this._map._layers[a].editing.removeHooks()}.bind(this)),this._layers.setStyle({fillColor:"#000",color:"#444",opacity:.95})},_distance:function(a,b){function c(a){return a*Math.PI/180}var d=57.2957795,e=c(b.lat-a.lat),f=c(b.lng-a.lng),g=Math.sin(e/2)*Math.sin(e/2)+Math.sin(f/2)*Math.sin(f/2)*Math.cos(c(a.lat))*Math.cos(c(b.lat)),h=2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g));return d*h/2},_isBetween:function(a,b,c){var d=this._distance(a,b),e=(c.lat-a.lat)*(b.lng-a.lng)-(c.lng-a.lng)*(b.lat-a.lat);if(Math.abs(e)>d)return!1;var f=(c.lng-a.lng)*(b.lng-a.lng)+(c.lat-a.lat)*(b.lat-a.lat);if(0>f)return!1;var g=(b.lng-a.lng)*(b.lng-a.lng)+(b.lat-a.lat)*(b.lat-a.lat);return f>g?!1:!0},redrawPolys:function(a){a.forEach(function(a){this._map._layers[a].editing.enabled&&(this._map._layers[a].editing.removeHooks(),this._map._layers[a].editing.addHooks())}.bind(this))},reset:function(a){Object.keys(this._map._layers).forEach(function(a){Object.keys(this._map._layers).forEach(function(b){this._map._layers[a]._latlngs&&this._map._layers[b]._latlngs&&this._map._layers[a]._latlngs.forEach(function(c,d){c._layer=a,c._index=d,this._map._layers[b]._latlngs.forEach(function(d){c.lat===d.lat&&c.lng===d.lng&&a!==b&&(c._hasTwin=!0,c._twinLayers||(c._twinLayers=[]),c._twinLayers.indexOf(b)<0&&c._twinLayers.push(b),d._hasTwin=!0,d._twinLayers||(d._twinLayers=[]),d._twinLayers.indexOf(a)<0&&d._twinLayers.push(a),this._map._layers[a].adjacencies.indexOf(b)<0&&this._map._layers[a].adjacencies.push(b),this._map._layers[b].adjacencies.indexOf(a)<0&&this._map._layers[b].adjacencies.push(a))}.bind(this))}.bind(this))}.bind(this))}.bind(this)),a()},match:function(a){a.forEach(function(b){a.forEach(function(a){this._map._layers[b]._latlngs.forEach(function(c,d){c._layer=b,c._index=d,this._map._layers[a]._latlngs.forEach(function(d){c.lat===d.lat&&c.lng===d.lng&&b!==a&&(c._hasTwin=!0,c._twinLayers||(c._twinLayers=[]),c._twinLayers.indexOf(a)<0&&c._twinLayers.push(a),d._hasTwin=!0,d._twinLayers||(d._twinLayers=[]),d._twinLayers.indexOf(b)<0&&d._twinLayers.push(b),this._map._layers[b].adjacencies.indexOf(a.toString())<0&&this._map._layers[b].adjacencies.push(a.toString()),this._map._layers[a].adjacencies.indexOf(b.toString())<0&&this._map._layers[a].adjacencies.push(b.toString()))}.bind(this))}.bind(this))}.bind(this))}.bind(this))},addMissingVertex:function(a,b,c,d,e){if(this._isBetween(c,this._map._layers[a]._latlngs[d+1],e)){var f=[c.lat,c.lng],g=[this._map._layers[a]._latlngs[d+1].lat,this._map._layers[a]._latlngs[d+1].lng],h=[e.lat,e.lng],i=f.filter(function(a){return-1!=h.indexOf(a)}),j=g.filter(function(a){return-1!=h.indexOf(a)});if(1===i.length&&1===j.length){var k={lat:e.lat,lng:e.lng,layer:a,_twinLayers:[a,b],_hasTwin:!0};this._map._layers[a]._latlngs.splice(d+1,0,k)}}},missingVertices:function(a){Object.keys(this._map._layers).forEach(function(a){Object.keys(this._map._layers).forEach(function(b){this._map._layers[a]._latlngs&&this._map._layers[b]._latlngs&&a!=b&&this._map._layers[a]._latlngs.forEach(function(c,d){this._map._layers[b]._latlngs.forEach(function(e){d+1<=this._map._layers[a]._latlngs.length-1&&d<this._map._layers[a]._latlngs.length-1?this.addMissingVertex(a,b,c,d,e):d===this._map._layers[a]._latlngs.length-1&&this.addMissingVertex(a,b,c,-1,e)}.bind(this))}.bind(this))}.bind(this))}.bind(this)),this.reset(a)},editLayer:function(a){this._map.addLayer(this.marker),this.marker.snapediting.enable(),this._findAdjacencies("enable",a)}};